# ==========================================
# 1. GENERAL SETTINGS
# ==========================================

# Unbind ALL default keys
unbind -a
set -g mouse on
set -g base-index 1              # Start windows at 1
set -g pane-base-index 1         # Start panes at 1
set -g renumber-windows on       # Re-number windows when one is closed
set -g default-terminal "tmux-256color"
set-option -g status-position top # Bar at the top


# ==========================================
# 2. PLUGINS & THEME (Minimal Catppuccin)
# ==========================================
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'


# --- Theme Configuration (Catppuccin Mocha) ---
#
# Minimal Status Bar (Transparent background)
set -g status-bg default
set -g status-style "bg=default"

# Left side: Empty (Clean look)
set -g status-left-length 100
set -g status-left ""

# Right side: Session name with subtle box
set -g status-right-length 50
set -g status-right "#[fg=#3b4261,bg=default]#[fg=#9ece6a,bg=#3b4261]  #S #[fg=#3b4261,bg=default]"
set -g status-justify left

# Window (Tab) Styling
set -g window-status-format "#[fg=#2e3d32,bg=default]#[fg=#7aa874,bg=#2e3d32] #I #W #[fg=#2e3d32,bg=default]"
set -g window-status-current-format "#[fg=#9ece6a,bg=default]#[fg=#1a1b26,bg=#9ece6a,bold] #I #W #[fg=#9ece6a,bg=default]"
set -g window-status-separator "  "



# ==========================================
# . MODAL BINDINGS
# ==========================================

# --- ROOT TRIGGERS ---
bind -n C-p switch-client -T pane
bind -n C-t switch-client -T tab
bind -n C-y switch-client -T resize
bind -n C-s if-shell "$is_vim" "send-keys C-s" "copy-mode" # Smart Scroll
bind -n C-k switch-client -T session
# locking should be disabled always
# bind -n C-g switch-client -T locked
bind -n C-m switch-client -T move 

# --- PANE MODE (Ctrl p) ---
bind -T pane h select-pane -L
bind -T pane j select-pane -D
bind -T pane k select-pane -U
bind -T pane l select-pane -R
bind -T pane p select-pane -t :.+
bind -T pane n split-window -h
bind -T pane d split-window -v
bind -T pane r split-window -h
bind -T pane x kill-pane
bind -T pane f resize-pane -Z
bind -T pane c command-prompt -I "#T" "select-pane -T '%%'"
bind -T pane w display-popup -E "tmux list-sessions"
bind -T pane Escape switch-client -T root
bind -T pane Enter switch-client -T root

# --- TAB MODE (Ctrl t) ---
bind -T tab h previous-window
bind -T tab l next-window
bind -T tab n new-window
bind -T tab x kill-window
bind -T tab r command-prompt -I "#W" "rename-window '%%'"
bind -T tab z resize-pane -Z  # Added Zoom to Tab mode for convenience
bind -T tab 1 select-window -t 1
bind -T tab 2 select-window -t 2
bind -T tab 3 select-window -t 3
bind -T tab 4 select-window -t 4
bind -T tab 5 select-window -t 5
bind -T tab Escape switch-client -T root
bind -T tab Enter switch-client -T root

# --- RESIZE MODE (Ctrl y) ---
bind -T resize h resize-pane -L 5 \; switch-client -T resize
bind -T resize j resize-pane -D 5 \; switch-client -T resize
bind -T resize k resize-pane -U 5 \; switch-client -T resize
bind -T resize l resize-pane -R 5 \; switch-client -T resize
bind -T resize = resize-pane -Z   \; switch-client -T resize
bind -T resize Escape switch-client -T root
bind -T resize Enter switch-client -T root

# --- MOVE MODE (Alt m) ---
bind -T move h swap-pane -s '{left-of}'
bind -T move j swap-pane -s '{down-of}'
bind -T move k swap-pane -s '{up-of}'
bind -T move l swap-pane -s '{right-of}'
bind -T move n next-layout
bind -T move p previous-layout
bind -T move Escape switch-client -T root

# --- SCROLL/SEARCH MODE (Ctrl s) ---
set-window-option -g mode-keys vi
bind -T copy-mode-vi j send-keys -X cursor-down
bind -T copy-mode-vi k send-keys -X cursor-up
bind -T copy-mode-vi C-f send-keys -X page-down
bind -T copy-mode-vi C-b send-keys -X page-up
bind -T copy-mode-vi d send-keys -X halfpage-down
bind -T copy-mode-vi u send-keys -X halfpage-up
bind -T copy-mode-vi / command-prompt -p "(search down)" "send -X search-forward \"%%%\""
bind -T copy-mode-vi ? command-prompt -p "(search up)" "send -X search-backward \"%%%\""
bind -T copy-mode-vi c send-keys -X cancel
# Enable system clipboard (Mac)
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"

# --- SESSION MODE (Ctrl k) ---
bind -T session d detach
bind -T session w choose-tree -s
bind -T session Escape switch-client -T root
# Manual Save/Restore
bind -T session s run-shell ~/.tmux/plugins/tmux-resurrect/scripts/save.sh \; display-message "Session Saved!"
bind -T session r run-shell ~/.tmux/plugins/tmux-resurrect/scripts/restore.sh \; display-message "Session Restored!"

# --- LOCKED MODE (Ctrl g) ---
# we don't need lock mode now. we can add it later
# bind -T locked C-g switch-client -T root

# ==========================================
# 4. SMART LOGIC & UTILITIES
# ==========================================

# Smart Edge Navigation (Alt + h/l cycles tabs)
bind -n M-h if -F "#{pane_at_left}" "previous-window" "select-pane -L"
bind -n M-l if -F "#{pane_at_right}" "next-window" "select-pane -R"
bind -n M-k select-pane -U
bind -n M-j select-pane -D

# Move Tabs (Alt + Shift + h/l)
bind -n M-H swap-window -t -1 \; select-window -t -1
bind -n M-L swap-window -t +1 \; select-window -t +1

# Smart Scroll / Vim Check Logic
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

# Auto-Restore Settings
set -g @continuum-restore 'on'
set -g @continuum-save-interval '2'


# 2. Whitelist of programs to Auto-Start
# (Add your common tools here: ssh, npm, node, python, etc.)
# "ssh" -> matches exact command
# "~npm" -> matches any command starting with npm (like "npm run dev")
set -g @resurrect-processes 'lazygit nvim "~claude" "~codex" cursor-agent'


# ==========================================
# SMART SCROLL SWITCHER
# ==========================================
# 1. Checks if the active pane is running Vim or Neovim
# 2. If TRUE  (Vim)   -> Sends "Ctrl-s" to Vim (so you can save file)
# 3. If FALSE (Shell) -> Enters Tmux Scroll/Copy Mode (so you can search logs)

bind -n C-s if-shell 'ps -o state= -o comm= -t #{pane_tty} | grep -iqE "^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$"' \
    "send-keys C-s" \
    "copy-mode"

# ==========================================
# 5. INITIALIZE (Must be at the VERY BOTTOM)
# ==========================================
run '~/.tmux/plugins/tpm/tpm'


# ==========================================
# FORCE BORDERS (Must be at the very bottom)
# ==========================================

# Pane borders (thin single line)
set -g pane-border-lines single

# Active pane: Green accent (matches active tab)
set -g pane-active-border-style bg=default,fg=#9ece6a

# Inactive panes: Subtle grey
set -g pane-border-style bg=default,fg=#3b4261


set -g @resurrect-strategy-nvim 'session'
